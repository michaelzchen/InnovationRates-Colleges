---
title: "Gather"
author: "Michael Chen"
date: "3/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load libraries

library(tidyverse)
library(dplyr)
library(readr)
library(janitor)
library(gt)
library(rvest)
library(scales)
library(ggplot2)
library(ggthemes)
library(urbnmapr)
library(ggmap)
library(gganimate)
```

```{r downloading, include = FALSE, cache = TRUE}

# Read in the 2 datasets

colleges <- read_csv("1005 final project data/Most-Recent-Cohorts-All-Data-Elements (1).csv")
innovationRates <- read_csv("1005 final project data/innovationRates.csv")

# Clean the 2 datasets

colleges <- clean_names(colleges, "snake")
innovationRates <- clean_names(innovationRates, "snake")

# View the colleges dataset in long form, so that you can better see the different variables and select only the ones that matter for this project
```

```{r cleaning, include = FALSE}

# Select out only the variables that we are interested in the colleges dataset.
# We want to keep all the variables in the innovationRates dataset so don't
# change anything found there. Store this new data in the newColleges dataset.
# In addition, because we know we eventually want to join these 2 datasets so we
# can perform analysis,

newColleges <- colleges %>%
  select(-insturl, -accredagency, -hcm2, -main, -starts_with("cip"), -starts_with("c150"), -starts_with("num"), -starts_with("dep"), -starts_with("ind"), -starts_with("female"), -starts_with("male"), -starts_with("loan"), -starts_with("noloan"), -starts_with("firstgen"), -starts_with("not1stgen"), -starts_with("pell"), -starts_with("nopell"), -starts_with("low_inc"), -starts_with("mid_inc"), -starts_with("hi_inc"), -starts_with("npt4"), -contains("rpy"), -starts_with("count"), -starts_with("mn_earn"), -starts_with("d150"), -starts_with("om"), -starts_with("ret"), -starts_with("pool"), -unitid, -opeid) %>%
  mutate(super_opeid = str_sub(opeid6, 3, -1)) %>%
  select(super_opeid, everything()) %>%
  select(-opeid6)

# Need to convert the super_opeid data frame into a numeric column so we can join the 2 together in both datasets.

newColleges$super_opeid <- as.numeric(as.character(newColleges$super_opeid))

# Use an inner join to merge the 2 datasets by super_opeid (the ID variable for each institution) and keep all the columns in both of the datasets.

joined <- inner_join(innovationRates, newColleges, by = "super_opeid")

# Remove the duplicates (if the super_opeid is the same, delete)

newJoined <- joined[!duplicated(joined$super_opeid), ]
final <- newJoined %>% select(-instnm.y)
```

```{r ggplot, warning = FALSE}

# Now that I have the tibble I am interested in (called final), I can now create several plots.

ggplot(final, aes(x = as.numeric(adm_rate), inventor, color = inventor)) +
  geom_point(size = 1.5, show.legend = FALSE) +
  labs(title = "Correlation of Admissions Rate for Each College Against Inventors", x = "Admissions Rate", y = "Percentage of Students That Are Inventors") +
  scale_y_continuous(labels = scales::percent) + scale_x_continuous(labels = scales::percent) + geom_smooth(method = "lm", se = TRUE) + theme_classic()
  
ggsave("v1/Reg_Adm_Rates_Inventors.png")
```

```{r relationalPlots, warning = FALSE}

# Now that I have the tibble I am interested in (called final), I can now create several plots.

ggplot(final, aes(x = as.numeric(count_pq1), y = inventor, color = inventor_pq1)) +
  geom_jitter() +
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "Admissions Rate", y = "Percentage of Students That Are Inventors") + scale_y_continuous(labels = scales::percent) + theme_classic()

# Overall SAT average

ggplot(final, aes(x = as.numeric(sat_avg), y = inventor)) +
  geom_jitter() +
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "SAT Average Score", y = "Percentage of Students That Are Inventors") + scale_y_continuous(labels = scales::percent) + geom_smooth(method = "lm", se = TRUE)  + theme_classic()

# Comparing SAT midpoint scores in critical reading, writing, and math, to see which has the greatest effect on inventor rate

ggplot(final) +
  geom_line(aes(x = as.numeric(satvrmid), y = inventor), color = 'blue') + geom_line(aes(x = as.numeric(satmtmid), y = inventor), color = 'red', linetype = 'dotted') + geom_line(aes(x = as.numeric(satwrmid), y = inventor), color = 'green') + 
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "SAT Average Score", y = "Percentage of Students That Are Inventors in Student Body") + scale_y_continuous(labels = scales::percent) + theme_classic()

# Comparing ACT midpoint scores in reading, writing, and math, to see if standardized tests have any prediction on inventor rate

ggplot(final) +
  geom_line(aes(x = as.numeric(actenmid), y = inventor), color = 'blue') + geom_line(aes(x = as.numeric(actmtmid), y = inventor), color = 'red', linetype = 'dotted') + geom_line(aes(x = as.numeric(actwrmid), y = inventor), color = 'green') + 
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "ACT Average Score", y = "Percentage of Students That Are Inventors in Student Body") + scale_color_manual(c("red", "blue", "green")) + scale_y_continuous(labels = scales::percent) + theme_classic()

# Comparing size of class

ggplot(final, aes(x = as.numeric(ugds), y = inventor)) +
  geom_jitter() +
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "Undergraduate Student Population Size", y = "Percentage of Students That Are Inventors") + scale_y_continuous(labels = scales::percent) + geom_smooth(method = "lm", se = TRUE)  + theme_classic()
```

```{r, warning = FALSE}
# Comparing average cost of attendance

ggplot(final, aes(x = as.numeric(costt4_a), y = inventor)) +
  geom_jitter() +
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "Undergraduate Student Population Size", y = "Percentage of Students That Are Inventors") + scale_y_continuous(labels = scales::percent) + geom_smooth(method = "lm", se = TRUE)  + theme_classic()

# Average faculty salary

ggplot(final, aes(x = as.numeric(avgfacsal), y = inventor)) +
  geom_jitter() +
  labs(title = "Regression of Admissions Rate for Each College Against Inventors", x = "Undergraduate Student Population Size", y = "Percentage of Students That Are Inventors") + scale_y_continuous(labels = scales::percent) + geom_smooth(method = "lm", se = FALSE)  + theme_classic()

# Proportionl of faculty that is 

# Comparing tuition fees (both in state and out)

```

```{r creatingMaps}
final <- final %>% rename("state_fips" = "st_fips")
counties$state_fips = as.numeric(as.character(counties$state_fips))
map_data <- left_join(final, counties, by = "state_fips") 
```

```{r, warning = FALSE}
map_data %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45)

ggsave("v1/MapsOriginal.png")
```

```{r Create linear models}
final1 <- final %>% 
  select(inventor, sat_avg, super_opeid)

lm <- final %>%
  group_by(super_opeid) %>%
  nest() %>%
  mutate(mod = map(data, ~ lm(inventor ~ as.numeric(sat_avg), data = .))) %>%
  mutate(reg_results = map(mod, ~ tidy(.))) %>%
  mutate(coef = map_dbl(reg_results, ~ filter(., term == "avgfascal") %>% pull(estimate))) %>%
  mutate(se = map_dbl(reg_results, ~ filter(., term == "avgfascal") %>% pull(std.error))) %>%
  mutate(upper = coef + (1.96 * se), lower = coef - (1.96 * se))

linearModel %>% ggplot() +
  geom_point(mapping = aes(x = super_opeid, y = coef), color = "blue") +
  geom_errorbar(aes(x = super_opeid, ymin = lower, ymax = upper), color = "red") +
  labs(
    x = "Congress",
    y = "Estimate",
    title = "Average Treatment Effect of Age on Conservatism \n Among Democrats Over Time", subtitle = "Scores use DW Nominate Dimension 1 \n 95% Confidence Interval"
  ) +
  theme_classic()
```








